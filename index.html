<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CapoLavoro.ie - Find your perfect Irish recruiter. Search 500+ vetted Irish recruitment agencies by location and specialization.">
  <meta property="og:title" content="CapoLavoro.ie - Irish Recruitment Agencies Directory">
  <meta property="og:description" content="Find and connect with Irish recruitment agencies instantly. Filter by county, specialization, and contact all relevant recruiters at once.">
  <meta property="og:type" content="website">
  <title>CapoLavoro.ie - Irish Recruitment Agencies Directory</title>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Leaflet CSS & JS for Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  
  <!-- Leaflet MarkerCluster for better performance with many markers -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #0f766e;
      --primary-dark: #0d5e57;
      --secondary: #059669;
      --accent: #f59e0b;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --border: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .font-mono {
      font-family: 'Space Mono', monospace;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-main);
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    .animate-slideUp {
      animation: slideUp 0.4s ease-out;
    }

    .animate-slideInRight {
      animation: slideInRight 0.3s ease-out;
    }

    /* Gradient Background */
    .gradient-bg {
      background: linear-gradient(135deg, #0f766e 0%, #059669 100%);
    }

    /* Card Hover Effect */
    .agency-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .agency-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px -10px rgba(15, 118, 110, 0.2);
    }

    /* Input Focus States */
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }

    /* Button Styles */
    .btn-primary {
      background: var(--primary);
      color: white;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
    }

    .btn-secondary {
      background: white;
      border: 2px solid var(--border);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    /* Modal Overlay */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
      background: #f0fdfa;
      color: var(--primary);
      border: 1px solid #ccfbf1;
    }

    /* Irish Flag Colors Accent */
    .irish-accent {
      background: linear-gradient(90deg, #169b62 0%, #ffffff 50%, #ff883e 100%);
      height: 3px;
    }

    /* Sticky Sidebar */
    .sticky-sidebar {
      position: sticky;
      top: 6rem;
      max-height: calc(100vh - 7rem);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
    }

    .sticky-sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sticky-sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sticky-sidebar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .sticky-sidebar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Map Styles */
    .map-container-small {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .map-header h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .btn-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--primary);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--bg-main);
      color: var(--primary-dark);
    }

    .map-small {
      height: 250px;
      width: 100%;
    }

    .map-container-large {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .map-header-large {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 2px solid var(--border);
      background: white;
    }

    .map-header-large h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .map-large {
      flex: 1;
      width: 100%;
    }

    /* Leaflet Popup Customization */
    .leaflet-popup-content-wrapper {
      border-radius: 0.5rem;
      padding: 0;
    }

    .leaflet-popup-content {
      margin: 0;
      min-width: 250px;
    }

    .popup-agency {
      padding: 1rem;
    }

    .popup-agency h4 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }

    .popup-agency p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: start;
      gap: 0.5rem;
    }

    .popup-agency a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .popup-agency a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* Loading Spinner */
    .map-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .sticky-sidebar {
        position: relative;
        top: auto;
        max-height: none;
        overflow-y: visible;
      }

      .map-small {
        height: 200px;
      }
    }

    @media (max-width: 768px) {
      .sticky-sidebar {
        position: relative;
        top: auto;
        max-height: none;
        overflow-y: visible;
      }

      .map-small {
        height: 180px;
      }
      
      .map-header h3 {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // DATA LOADING STRATEGY:
    // Loads from agencies.csv in the SAME FOLDER as this HTML file
    // Place agencies.csv next to capolavoro-dashboard.html
    // If file not found, falls back to embedded sample data (20 agencies) for demo purposes
    const CSV_DATA_PATH = './agencies.csv';

    // Geocoding cache to avoid repeated API calls
    const geocodeCache = new Map();

    // Onboarding Modal Component
    const OnboardingModal = ({ onClose, onComplete }) => {
      const [currentStep, setCurrentStep] = useState(0);
      const [dontShowAgain, setDontShowAgain] = useState(false);

      const steps = [
        {
          title: "Welcome to CapoLavoro.ie",
          content: "Your masterpiece of work starts here. Search through 500+ vetted Irish recruitment agencies by location and specialization. Connect with the right recruiters for your industry in seconds.",
          icon: "üéØ"
        },
        {
          title: "Search & Filter Your Way",
          content: (
            <div className="space-y-3">
              <p className="text-sm">Use powerful filters to find exactly what you need:</p>
              <ul className="text-sm space-y-2 text-left">
                <li className="flex items-start gap-2">
                  <span className="text-teal-600">üìç</span>
                  <span><strong>County:</strong> Select your location (Dublin, Cork, etc.)</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-teal-600">üíº</span>
                  <span><strong>Specialization:</strong> Choose your industry (IT, Healthcare, Finance)</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-teal-600">üîç</span>
                  <span><strong>Name Search:</strong> Type to find specific agencies instantly</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-teal-600">‚úâÔ∏è</span>
                  <span><strong>Contact Filters:</strong> Show only agencies with email, phone, or website</span>
                </li>
              </ul>
            </div>
          ),
          icon: "üîç"
        },
        {
          title: "See Agencies on a Map",
          content: "View agency locations on an interactive map in the sidebar. Click to maximize for a full-screen map view with all contact details. Perfect for finding recruiters near you!",
          icon: "üó∫Ô∏è"
        },
        {
          title: "Copy All Emails at Once",
          content: (
            <div className="space-y-3">
              <p className="text-sm font-semibold text-teal-600">This is the game-changer:</p>
              <ul className="text-sm space-y-2 text-left">
                <li className="flex items-start gap-2">
                  <span>‚ú®</span>
                  <span>Click <strong>"Copy All Emails"</strong> to copy all filtered results</span>
                </li>
                <li className="flex items-start gap-2">
                  <span>üìß</span>
                  <span>Paste into your email client's <strong>BCC field</strong> (not CC or To)</span>
                </li>
                <li className="flex items-start gap-2">
                  <span>üöÄ</span>
                  <span>Send one email to multiple recruiters simultaneously</span>
                </li>
                <li className="flex items-start gap-2 bg-amber-50 p-2 rounded-lg border border-amber-200">
                  <span>‚ö†Ô∏è</span>
                  <span className="text-amber-800"><strong>Important:</strong> Always use BCC to keep recipient emails private!</span>
                </li>
              </ul>
            </div>
          ),
          icon: "‚úâÔ∏è"
        },
        {
          title: "You're All Set!",
          content: "Start exploring Irish recruitment agencies now. Filter by your criteria, view them on the map, and connect with the right recruiters for your career journey.",
          icon: "üéâ"
        }
      ];

      const currentStepData = steps[currentStep];

      const handleNext = () => {
        if (currentStep < steps.length - 1) {
          setCurrentStep(currentStep + 1);
        } else {
          handleComplete();
        }
      };

      const handleBack = () => {
        if (currentStep > 0) {
          setCurrentStep(currentStep - 1);
        }
      };

      const handleComplete = () => {
        if (dontShowAgain) {
          localStorage.setItem('capolavoro_onboarding_seen', 'true');
        }
        onComplete();
      };

      const handleSkip = () => {
        localStorage.setItem('capolavoro_onboarding_seen', 'true');
        onComplete();
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-slideUp">
            <div className="gradient-bg text-white p-6 rounded-t-2xl relative">
              <div className="irish-accent absolute top-0 left-0 right-0"></div>
              <button
                onClick={handleSkip}
                className="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors"
                aria-label="Close"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              <div className="text-center">
                <div className="text-6xl mb-4">{currentStepData.icon}</div>
                <h2 className="text-2xl font-bold">{currentStepData.title}</h2>
              </div>
            </div>

            <div className="p-8">
              <div className="text-center mb-6 text-gray-700">
                {typeof currentStepData.content === 'string' ? (
                  <p className="text-base leading-relaxed">{currentStepData.content}</p>
                ) : (
                  currentStepData.content
                )}
              </div>

              <div className="flex justify-center gap-2 mb-6">
                {steps.map((_, index) => (
                  <div
                    key={index}
                    className={`h-2 rounded-full transition-all ${
                      index === currentStep 
                        ? 'w-8 bg-teal-600' 
                        : index < currentStep 
                          ? 'w-2 bg-teal-400' 
                          : 'w-2 bg-gray-300'
                    }`}
                  />
                ))}
              </div>

              <div className="flex gap-3 justify-between items-center">
                <button
                  onClick={handleBack}
                  disabled={currentStep === 0}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${
                    currentStep === 0
                      ? 'opacity-0 cursor-default'
                      : 'btn-secondary'
                  }`}
                >
                  Back
                </button>

                <span className="text-sm text-gray-500 font-mono">
                  Step {currentStep + 1} of {steps.length}
                </span>

                <button
                  onClick={handleNext}
                  className="px-6 py-2 rounded-lg font-medium btn-primary"
                >
                  {currentStep === steps.length - 1 ? "Get Started" : "Next"}
                </button>
              </div>

              {currentStep === steps.length - 1 && (
                <div className="mt-6 flex items-center justify-center gap-2">
                  <input
                    type="checkbox"
                    id="dontShowAgain"
                    checked={dontShowAgain}
                    onChange={(e) => setDontShowAgain(e.target.checked)}
                    className="w-4 h-4 text-teal-600 rounded border-gray-300 focus:ring-teal-500"
                  />
                  <label htmlFor="dontShowAgain" className="text-sm text-gray-600 cursor-pointer">
                    Don't show this again
                  </label>
                </div>
              )}

              {currentStep < steps.length - 1 && (
                <div className="text-center mt-4">
                  <button
                    onClick={handleSkip}
                    className="text-sm text-gray-500 hover:text-gray-700 underline"
                  >
                    Skip tutorial
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Map Component
    const AgencyMap = ({ agencies, isMaximized, onToggleMaximize }) => {
      const mapRefSmall = useRef(null);
      const mapRefLarge = useRef(null);
      const mapInstanceSmall = useRef(null);
      const mapInstanceLarge = useRef(null);
      const markersLayerSmall = useRef(null);
      const markersLayerLarge = useRef(null);
      const [isGeocoding, setIsGeocoding] = useState(false);
      const [geocodedAgencies, setGeocodedAgencies] = useState([]);

      // County center coordinates as fallback
      const countyCoordinates = {
        'Dublin': [53.3498, -6.2603],
        'Cork': [51.8969, -8.4863],
        'Galway': [53.2707, -9.0568],
        'Limerick': [52.6638, -8.6267],
        'Waterford': [52.2593, -7.1101],
        'Kerry': [52.2719, -9.5668],
        'Clare': [52.8445, -8.9857],
        'Mayo': [53.8584, -9.2898],
        'Donegal': [54.6537, -8.1089],
        'Sligo': [54.2697, -8.4694],
        'Wicklow': [52.9811, -6.0421],
        'Wexford': [52.3369, -6.4633],
        'Kilkenny': [52.6541, -7.2448],
        'Tipperary': [52.4747, -8.1614],
        'Carlow': [52.8410, -6.9269],
        'Kildare': [53.1560, -6.9109],
        'Meath': [53.6055, -6.6565],
        'Louth': [53.9494, -6.4036],
        'Offaly': [53.2749, -7.7154],
        'Laois': [52.9941, -7.3323],
        'Westmeath': [53.5344, -7.4653],
        'Cavan': [53.9909, -7.3606],
        'Monaghan': [54.2492, -6.9687],
        'Longford': [53.7277, -7.7935],
        'Roscommon': [53.6297, -8.1879],
        'Leitrim': [54.0675, -8.0773]
      };

      // Geocode address using Nominatim
      const geocodeAddress = async (agency) => {
        // Check cache first
        const cacheKey = `${agency.County}-${agency.Address || ''}`;
        if (geocodeCache.has(cacheKey)) {
          return geocodeCache.get(cacheKey);
        }

        try {
          // Construct search query for Irish addresses
          let searchQuery = '';
          if (agency.Address) {
            searchQuery = `${agency.Address}, ${agency.County}, Ireland`;
          } else {
            searchQuery = `${agency.County}, Ireland`;
          }

          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=ie&limit=1`,
            {
              headers: {
                'User-Agent': 'CapoLavoro.ie'
              }
            }
          );

          const data = await response.json();

          if (data && data.length > 0) {
            const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            geocodeCache.set(cacheKey, coords);
            return coords;
          } else {
            // Fallback to county center
            const countyCoords = countyCoordinates[agency.County] || [53.3498, -6.2603]; // Default to Dublin
            const coords = { lat: countyCoords[0], lng: countyCoords[1] };
            geocodeCache.set(cacheKey, coords);
            return coords;
          }
        } catch (error) {
          console.error('Geocoding error:', error);
          // Fallback to county center
          const countyCoords = countyCoordinates[agency.County] || [53.3498, -6.2603];
          const coords = { lat: countyCoords[0], lng: countyCoords[1] };
          geocodeCache.set(cacheKey, coords);
          return coords;
        }
      };

      // Geocode all agencies
      useEffect(() => {
        const geocodeAgencies = async () => {
          if (agencies.length === 0) {
            setGeocodedAgencies([]);
            return;
          }

          setIsGeocoding(true);
          const geocoded = [];

          // Geocode in batches to avoid rate limiting
          for (let i = 0; i < agencies.length; i++) {
            const agency = agencies[i];
            const coords = await geocodeAddress(agency);
            geocoded.push({ ...agency, ...coords });

            // Add delay to respect Nominatim rate limiting (1 request per second)
            if (i < agencies.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 1100));
            }
          }

          setGeocodedAgencies(geocoded);
          setIsGeocoding(false);
        };

        geocodeAgencies();
      }, [agencies]);

      // Initialize small map
      useEffect(() => {
        if (!mapRefSmall.current || mapInstanceSmall.current) return;

        const map = L.map(mapRefSmall.current, {
          center: [53.3498, -6.2603], // Dublin center
          zoom: 7,
          zoomControl: true,
          scrollWheelZoom: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);

        mapInstanceSmall.current = map;
        markersLayerSmall.current = L.markerClusterGroup();
        map.addLayer(markersLayerSmall.current);

        // Fix map rendering issues
        setTimeout(() => {
          map.invalidateSize();
        }, 100);

        return () => {
          if (mapInstanceSmall.current) {
            mapInstanceSmall.current.remove();
            mapInstanceSmall.current = null;
          }
        };
      }, []);

      // Initialize large map
      useEffect(() => {
        if (!isMaximized || !mapRefLarge.current || mapInstanceLarge.current) return;

        const map = L.map(mapRefLarge.current, {
          center: [53.3498, -6.2603],
          zoom: 7,
          zoomControl: true,
          scrollWheelZoom: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);

        mapInstanceLarge.current = map;
        markersLayerLarge.current = L.markerClusterGroup();
        map.addLayer(markersLayerLarge.current);

        setTimeout(() => {
          map.invalidateSize();
        }, 100);

        return () => {
          if (mapInstanceLarge.current) {
            mapInstanceLarge.current.remove();
            mapInstanceLarge.current = null;
          }
        };
      }, [isMaximized]);

      // Update markers when geocoded agencies change
      useEffect(() => {
        const updateMarkers = (mapInstance, markersLayer) => {
          if (!mapInstance || !markersLayer || geocodedAgencies.length === 0) return;

          // Clear existing markers
          markersLayer.clearLayers();

          // Add new markers
          geocodedAgencies.forEach(agency => {
            if (agency.lat && agency.lng) {
              // Determine marker color based on specializations
              const fields = agency.Covered_Fields || '';
              let markerColor = '#6b7280'; // Default gray

              if (fields.toLowerCase().includes('it') || fields.toLowerCase().includes('technology')) {
                markerColor = '#3b82f6'; // Blue
              } else if (fields.toLowerCase().includes('healthcare') || fields.toLowerCase().includes('medical')) {
                markerColor = '#ef4444'; // Red
              } else if (fields.toLowerCase().includes('finance') || fields.toLowerCase().includes('accounting')) {
                markerColor = '#10b981'; // Green
              }

              // Create custom icon
              const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
              });

              // Create popup content
              const popupContent = `
                <div class="popup-agency">
                  <h4>${agency.Agency_Name}</h4>
                  ${agency.County ? `<p>üìç ${agency.County}${agency.Address ? `, ${agency.Address}` : ''}</p>` : ''}
                  ${agency.Covered_Fields ? `<p>üéØ ${agency.Covered_Fields}</p>` : ''}
                  ${agency.Phone ? `<p>üìû <a href="tel:${agency.Phone}">${agency.Phone}</a></p>` : ''}
                  ${agency.Email ? `<p>‚úâÔ∏è <a href="mailto:${agency.Email.split(/[|;]/)[0].trim()}">${agency.Email.split(/[|;]/)[0].trim()}</a></p>` : ''}
                  ${agency.Website ? `<p>üåê <a href="${agency.Website.split(/[|;]/)[0].trim()}" target="_blank">Visit Website</a></p>` : ''}
                </div>
              `;

              const marker = L.marker([agency.lat, agency.lng], { icon }).bindPopup(popupContent);
              markersLayer.addLayer(marker);
            }
          });

          // Fit bounds to show all markers
          if (markersLayer.getLayers().length > 0) {
            const bounds = markersLayer.getBounds();
            mapInstance.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
          }
        };

        if (mapInstanceSmall.current && markersLayerSmall.current) {
          updateMarkers(mapInstanceSmall.current, markersLayerSmall.current);
        }

        if (mapInstanceLarge.current && markersLayerLarge.current) {
          updateMarkers(mapInstanceLarge.current, markersLayerLarge.current);
        }
      }, [geocodedAgencies]);

      // Invalidate map size when maximized state changes
      useEffect(() => {
        if (isMaximized && mapInstanceLarge.current) {
          setTimeout(() => {
            mapInstanceLarge.current.invalidateSize();
          }, 100);
        }
      }, [isMaximized]);

      if (isMaximized) {
        return (
          <div className="map-container-large">
            <div className="map-header-large">
              <h3>üìç Agency Locations Map ({geocodedAgencies.length} agencies)</h3>
              <button
                onClick={onToggleMaximize}
                className="btn-primary px-6 py-2 rounded-lg font-medium"
              >
                ‚Üê View List
              </button>
            </div>
            <div ref={mapRefLarge} className="map-large"></div>
            {isGeocoding && (
              <div className="map-loading">
                <div className="spinner"></div>
                <p className="text-sm text-gray-600 mt-2">Loading map...</p>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="map-container-small">
          <div className="map-header">
            <h3>üìç Agency Locations ({geocodedAgencies.length})</h3>
            <button
              onClick={onToggleMaximize}
              className="btn-icon"
              title="Maximize Map"
            >
              ‚õ∂
            </button>
          </div>
          <div style={{ position: 'relative' }}>
            <div ref={mapRefSmall} className="map-small"></div>
            {isGeocoding && (
              <div className="map-loading">
                <div className="spinner"></div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Main Dashboard Component
    const RecruitmentDashboard = () => {
      const [agencies, setAgencies] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showOnboarding, setShowOnboarding] = useState(false);
      const [isMapMaximized, setIsMapMaximized] = useState(false);
      
      // Filter states
      const [selectedCounty, setSelectedCounty] = useState('');
      const [selectedField, setSelectedField] = useState('');
      const [searchTerm, setSearchTerm] = useState('');
      const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');
      const [hasEmail, setHasEmail] = useState(false);
      const [hasPhone, setHasPhone] = useState(false);
      const [hasWebsite, setHasWebsite] = useState(false);

      // Load CSV data from production source or embedded sample data
      useEffect(() => {
        const loadData = () => {
          // EMBEDDED SAMPLE DATA - Full 20 agencies for immediate use
          // Replace this with your own data or load from external CSV
          const embeddedSampleData = `County;Agency_Name;Trading_Name;Address;Licence_Number;Phone;Email;Website;Covered_Fields
Dublin;3D Personnel Limited;;Block 9 Airvista Office Park, Dublin 11;EA3321;+35315133101;dublin@3dpersonnel.com;https://3dpersonnel.com;Construction, Finance & Accounting, Engineering
Cork;CPL Resources;;83 Merrion Square, Cork;EA1089;+353214271444;cork@cpl.ie;https://cpl.ie;IT, Healthcare, Finance
Dublin;Excel Recruitment;;South County Business Park, Dublin 18;EA1156;+35312163400;info@excelrecruitment.com;https://excelrecruitment.com;Accounting, Engineering, IT, Sales
Galway;Sigmar Recruitment;;Galway Technology Park, Parkmore;EA2341;+353863772234;galway@sigmarrecruitment.com;https://sigmarrecruitment.com;IT, Engineering, Finance
Dublin;Morgan McKinley;;30 Herbert Street, Dublin 2;EA1892;+35316180100;info@morganmckinley.ie;https://morganmckinley.ie;Finance, Technology, Legal
Limerick;Fastnet Recruitment;;Castletroy Business Park, Limerick;EA3456;+353861234567;info@fastnetrecruitment.ie;https://fastnetrecruitment.ie;Engineering, Manufacturing
Dublin;Prosperity Recruitment;;Sandyford Industrial Estate, Dublin 18;EA2789;+35312975050;dublin@prosperityrecruitment.ie|jobs@prosperityrecruitment.ie;https://prosperityrecruitment.ie;Retail, Hospitality, Warehouse
Waterford;Osborne Recruitment;;The Quay Business Centre, Waterford;EA3102;+353874567890;info@osbornerecruitment.ie;https://osbornerecruitment.ie;Manufacturing, Engineering
Dublin;Hays Ireland;;2 Park Place, Citywest Business Campus;EA1567;+35316702800;info@hays.ie;https://hays.ie;IT, Construction, Finance, Healthcare
Cork;Sli Nua Careers;;South Mall, Cork City;EA2901;+353214801234;;https://slinuacareers.ie;Education, Social Care
Dublin;Thornton Recruitment;;Sandyford Business District, Dublin 18;EA2145;+35312345678;info@thornton.ie|jobs@thornton.ie;https://thornton.ie;Sales, Marketing, Digital
Galway;West Coast Staffing;;Eyre Square Centre, Galway;EA3567;+353915678901;galway@westcoast.ie;https://westcoaststaffing.ie;Hospitality, Retail, Customer Service
Dublin;Executive Search Partners;;St. Stephen's Green, Dublin 2;EA1678;+35317654321;executive@esp.ie;https://esp.ie;Executive, Finance, Legal, Technology
Limerick;Shannon Recruitment;;Raheen Business Park, Limerick;EA2890;+353618765432;info@shannon.ie;https://shannonrecruitment.ie;Engineering, Manufacturing, Logistics
Cork;Meridian Staffing;;Mahon Point, Cork;EA3234;+353214567890;cork@meridian.ie;https://meridianstaffing.ie;Industrial, Warehouse, Driving
Dublin;Tech Talent Ireland;;Blanchardstown Corporate Park, Dublin 15;EA4012;+35318901234;contact@techtalent.ie;https://techtalent.ie;Software Development, IT, Data Science
Galway;Celtic Careers;;Ballybrit Business Park, Galway;EA3789;+353919876543;info@celticcareers.ie;https://celticcareers.ie;Pharmaceutical, Life Sciences, Medical Devices
Kerry;Kingdom Recruitment;;Rock Street, Tralee;EA2456;+353667123456;kerry@kingdomrecruitment.ie;https://kingdomrecruitment.ie;Tourism, Hospitality, Retail
Waterford;Southeast Staffing;;John's Hill, Waterford City;EA3345;+353518888999;southeast@staffing.ie;https://southeaststaffing.ie;Manufacturing, Quality Control, Production
Dublin;Legal Eagles Recruitment;;Fitzwilliam Square, Dublin 2;EA4567;+35316667777;info@legaleagles.ie;https://legaleagles.ie;Legal, Compliance, Regulatory Affairs`;

          // Try to load from agencies.csv in the same folder
          // If successful, uses external CSV data
          // If not found, falls back to embedded sample data below
          fetch(CSV_DATA_PATH)
            .then(response => {
              if (!response.ok) {
                throw new Error('External CSV not found');
              }
              return response.text();
            })
            .then(csvText => {
              console.log('‚úÖ Loaded data from agencies.csv in same folder');
              Papa.parse(csvText, {
                header: true,
                delimiter: ';',
                skipEmptyLines: true,
                complete: (results) => {
                  setAgencies(results.data);
                  setLoading(false);
                }
              });
            })
            .catch(error => {
              // Use embedded sample data when external CSV not available
              console.log('‚ÑπÔ∏è Using embedded sample data (20 agencies)');
              Papa.parse(embeddedSampleData, {
                header: true,
                delimiter: ';',
                skipEmptyLines: true,
                complete: (results) => {
                  setAgencies(results.data);
                  setLoading(false);
                }
              });
            });
        };

        loadData();

        // Check if onboarding has been seen
        const hasSeenOnboarding = localStorage.getItem('capolavoro_onboarding_seen');
        if (!hasSeenOnboarding) {
          setShowOnboarding(true);
        }
      }, []);

      // Debounce search term
      useEffect(() => {
        const timer = setTimeout(() => {
          setDebouncedSearchTerm(searchTerm);
        }, 300);

        return () => clearTimeout(timer);
      }, [searchTerm]);

      // Extract unique counties
      const counties = useMemo(() => {
        const uniqueCounties = [...new Set(agencies.map(a => a.County).filter(Boolean))];
        return uniqueCounties.sort();
      }, [agencies]);

      // Extract unique fields
      const fields = useMemo(() => {
        const allFields = new Set();
        agencies.forEach(agency => {
          if (agency.Covered_Fields) {
            const fields = agency.Covered_Fields.split(/[,;]/).map(f => f.trim());
            fields.forEach(field => {
              if (field) allFields.add(field);
            });
          }
        });
        return Array.from(allFields).sort();
      }, [agencies]);

      // Filter agencies
      const filteredAgencies = useMemo(() => {
        return agencies.filter(agency => {
          if (selectedCounty && agency.County !== selectedCounty) {
            return false;
          }

          if (selectedField) {
            const agencyFields = agency.Covered_Fields 
              ? agency.Covered_Fields.split(/[,;]/).map(f => f.trim())
              : [];
            if (!agencyFields.includes(selectedField)) {
              return false;
            }
          }

          if (debouncedSearchTerm) {
            const searchLower = debouncedSearchTerm.toLowerCase();
            const nameMatch = agency.Agency_Name?.toLowerCase().includes(searchLower);
            const tradingMatch = agency.Trading_Name?.toLowerCase().includes(searchLower);
            if (!nameMatch && !tradingMatch) {
              return false;
            }
          }

          if (hasEmail && !agency.Email) return false;
          if (hasPhone && !agency.Phone) return false;
          if (hasWebsite && !agency.Website) return false;

          return true;
        });
      }, [agencies, selectedCounty, selectedField, debouncedSearchTerm, hasEmail, hasPhone, hasWebsite]);

      // Extract all emails from filtered agencies
      const extractEmails = useCallback(() => {
        const emails = [];
        filteredAgencies.forEach(agency => {
          if (agency.Email) {
            const emailList = agency.Email.split(/[|;]/).map(e => e.trim()).filter(Boolean);
            emails.push(...emailList);
          }
        });
        return [...new Set(emails)];
      }, [filteredAgencies]);

      // Copy emails to clipboard
      const copyEmails = () => {
        const emails = extractEmails();
        if (emails.length === 0) {
          alert('No emails found in filtered results');
          return;
        }
        
        const emailString = emails.join('; ');
        navigator.clipboard.writeText(emailString).then(() => {
          alert(`‚úÖ Copied ${emails.length} email(s) to clipboard!\n\nPaste into BCC field of your email client.`);
        }).catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy emails. Please try again.');
        });
      };

      // Clear all filters
      const clearFilters = () => {
        setSelectedCounty('');
        setSelectedField('');
        setSearchTerm('');
        setHasEmail(false);
        setHasPhone(false);
        setHasWebsite(false);
      };

      // Parse multiple values
      const parseMultipleValues = (value, separator = '|') => {
        if (!value) return [];
        return value.split(separator).map(v => v.trim()).filter(Boolean);
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-teal-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading agencies...</p>
            </div>
          </div>
        );
      }

      return (
        <>
          {showOnboarding && (
            <OnboardingModal
              onClose={() => setShowOnboarding(false)}
              onComplete={() => setShowOnboarding(false)}
            />
          )}

          <div className="min-h-screen">
            {/* Header */}
            <header className="gradient-bg text-white shadow-lg sticky top-0 z-40">
              <div className="irish-accent"></div>
              <div className="container mx-auto px-4 py-6">
                <div className="flex items-center justify-between">
                  <div>
                    <h1 className="text-3xl font-bold mb-1">CapoLavoro.ie</h1>
                    <p className="text-teal-100 text-sm">Find Your Perfect Irish Recruiter</p>
                  </div>
                  <button
                    onClick={() => setShowOnboarding(true)}
                    className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-all"
                  >
                    üìö View Tutorial
                  </button>
                </div>
              </div>
            </header>

            <div className="container mx-auto px-4 py-8">
              <div className="flex flex-col lg:flex-row gap-6">
                {/* Sidebar Filters */}
                <aside className="lg:w-80 flex-shrink-0">
                  <div className="sticky-sidebar space-y-4" style={{ paddingRight: '4px' }}>
                    <div className="bg-white rounded-xl shadow-lg p-6 animate-slideInRight">
                      <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Filters</h2>
                        <button
                          onClick={clearFilters}
                          className="text-sm text-teal-600 hover:text-teal-700 font-medium underline"
                        >
                          Clear All
                        </button>
                      </div>

                      <div className="space-y-6">
                        {/* County Filter */}
                        <div>
                          <select
                            value={selectedCounty}
                            onChange={(e) => setSelectedCounty(e.target.value)}
                            className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-teal-600 transition-colors"
                          >
                            <option value="">All Counties</option>
                            {counties.map(county => (
                              <option key={county} value={county}>{county}</option>
                            ))}
                          </select>
                        </div>

                        {/* Field Filter */}
                        <div>
                          <select
                            value={selectedField}
                            onChange={(e) => setSelectedField(e.target.value)}
                            className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-teal-600 transition-colors"
                          >
                            <option value="">All Specializations</option>
                            {fields.map(field => (
                              <option key={field} value={field}>{field}</option>
                            ))}
                          </select>
                        </div>

                        

                        {/* Search Filter */}
                        <div>
                          <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Search by name..."
                            className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-teal-600 transition-colors"
                          />
                        </div>

                        {/* Contact Info Filters */}
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-3">
                            Contact Information
                          </label>
                          <div className="space-y-2">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={hasEmail}
                                onChange={(e) => setHasEmail(e.target.checked)}
                                className="w-4 h-4 text-teal-600 rounded border-gray-300 focus:ring-teal-500"
                              />
                              <span className="text-sm text-gray-700">Email</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={hasPhone}
                                onChange={(e) => setHasPhone(e.target.checked)}
                                className="w-4 h-4 text-teal-600 rounded border-gray-300 focus:ring-teal-500"
                              />
                              <span className="text-sm text-gray-700">Phone</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={hasWebsite}
                                onChange={(e) => setHasWebsite(e.target.checked)}
                                className="w-4 h-4 text-teal-600 rounded border-gray-300 focus:ring-teal-500"
                              />
                              <span className="text-sm text-gray-700">Website</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Map Component in Sidebar - Now inside sticky container */}
                    {!isMapMaximized && (
                      <AgencyMap
                        agencies={filteredAgencies}
                        isMaximized={false}
                        onToggleMaximize={() => setIsMapMaximized(true)}
                      />
                    )}
                  </div>
                </aside>

                {/* Main Content */}
                {!isMapMaximized && (
                  <main className="flex-1">
                    {/* Results Header */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6 animate-slideUp">
                      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <div>
                          <p className="text-2xl font-bold text-gray-800">
                            {filteredAgencies.length} {filteredAgencies.length === 1 ? 'Agency' : 'Agencies'}
                          </p>
                          <p className="text-sm text-gray-600">
                            {agencies.length === filteredAgencies.length 
                              ? 'Showing all agencies' 
                              : `Filtered from ${agencies.length} total`}
                          </p>
                        </div>
                        <button
                          onClick={copyEmails}
                          disabled={extractEmails().length === 0}
                          className={`px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 ${
                            extractEmails().length === 0
                              ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                              : 'btn-primary'
                          }`}
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                          Copy All Emails ({extractEmails().length})
                        </button>
                      </div>
                    </div>

                    {/* Results Grid */}
                    {filteredAgencies.length === 0 ? (
                      <div className="bg-white rounded-xl shadow-lg p-12 text-center animate-slideUp">
                        <div className="text-6xl mb-4">üîç</div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">No agencies found</h3>
                        <p className="text-gray-600 mb-6">Try adjusting your filters or search terms</p>
                        <button
                          onClick={clearFilters}
                          className="btn-primary px-6 py-2 rounded-lg font-medium"
                        >
                          Clear All Filters
                        </button>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {filteredAgencies.map((agency, index) => (
                          <div
                            key={index}
                            className="agency-card bg-white rounded-xl shadow-lg p-6 animate-slideUp"
                            style={{ animationDelay: `${index * 0.05}s` }}
                          >
                            <div className="flex flex-col lg:flex-row gap-6">
                              {/* Left Column */}
                              <div className="flex-1">
                                <h3 className="text-xl font-bold text-gray-800 mb-2">
                                  {agency.Agency_Name}
                                </h3>
                                {agency.Trading_Name && (
                                  <p className="text-sm text-gray-600 mb-3">
                                    Trading as: {agency.Trading_Name}
                                  </p>
                                )}
                                
                                {agency.Address && (
                                  <p className="text-sm text-gray-600 mb-2 flex items-start gap-2">
                                    <span className="text-teal-600">üìç</span>
                                    {agency.Address}
                                  </p>
                                )}
                                
                                {agency.County && (
                                  <p className="text-sm text-gray-600 mb-3 flex items-center gap-2">
                                    <span className="text-teal-600">üèõÔ∏è</span>
                                    {agency.County}
                                  </p>
                                )}

                                {agency.Licence_Number && (
                                  <p className="text-xs text-gray-500 font-mono">
                                    License: {agency.Licence_Number}
                                  </p>
                                )}
                              </div>

                              {/* Right Column */}
                              <div className="lg:w-80 space-y-3">
                                {/* Contact Info */}
                                {agency.Phone && (
                                  <a
                                    href={`tel:${agency.Phone}`}
                                    className="block w-full px-4 py-2 bg-teal-50 hover:bg-teal-100 text-teal-700 rounded-lg text-sm font-medium transition-colors text-center"
                                  >
                                    üìû {agency.Phone}
                                  </a>
                                )}

                                {agency.Email && (
                                  <div className="space-y-1">
                                    {parseMultipleValues(agency.Email, /[|;]/).map((email, idx) => (
                                      <a
                                        key={idx}
                                        href={`mailto:${email}`}
                                        className="block w-full px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm font-medium transition-colors text-center"
                                      >
                                        ‚úâÔ∏è {email}
                                      </a>
                                    ))}
                                  </div>
                                )}

                                {agency.Website && (
                                  <div className="space-y-1">
                                    {parseMultipleValues(agency.Website, /[|;]/).map((url, idx) => (
                                      <a
                                        key={idx}
                                        href={url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="block w-full px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm font-medium transition-colors text-center"
                                      >
                                        üåê Visit Website
                                      </a>
                                    ))}
                                  </div>
                                )}

                                {/* Specializations */}
                                {agency.Covered_Fields && (
                                  <div className="pt-2">
                                    <p className="text-xs font-semibold text-gray-600 mb-2">SPECIALIZATIONS:</p>
                                    <div className="flex flex-wrap gap-2">
                                      {agency.Covered_Fields.split(/[,;]/).map((field, idx) => (
                                        <span key={idx} className="badge">
                                          {field.trim()}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </main>
                )}

                {/* Maximized Map View */}
                {isMapMaximized && (
                  <AgencyMap
                    agencies={filteredAgencies}
                    isMaximized={true}
                    onToggleMaximize={() => setIsMapMaximized(false)}
                  />
                )}
              </div>
            </div>

            {/* Footer */}
            <footer className="bg-white border-t border-gray-200 mt-12">
              <div className="container mx-auto px-4 py-6 text-center text-sm text-gray-600">
                <p>CapoLavoro.ie ‚Ä¢ Find Your Perfect Irish Recruiter ‚Ä¢ Built with ‚ù§Ô∏è for job seekers</p>
              </div>
            </footer>
          </div>
        </>
      );
    };

    // Render App
    ReactDOM.render(<RecruitmentDashboard />, document.getElementById('root'));
  </script>
</body>
</html>